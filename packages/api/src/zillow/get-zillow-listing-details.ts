import axios from 'axios'
import dayjs from 'dayjs'
import { type ZillowListing } from './types.js'
import { getZillowCookie } from './config.js'

const zillowListingHeaders = {
  'accept': '*/*',
  'accept-encoding': 'gzip, deflate, br, zstd',
  'accept-language': 'en-US,en;q=0.9',
  'client-id': 'for-sale-sub-app-browser-client',
  'content-type': 'application/json',
  'Cache-Control': 'no-cache',
  'Pragma': 'no-cache',
  'priority': 'u=1, i',
  'sec-ch-ua': '"Not(A:Brand";v="99", "Google Chrome";v="133", "Chromium";v="133"',
  'sec-ch-ua-mobile': '?0',
  'sec-ch-ua-platform': '"macOS"',
  'sec-fetch-dest': 'empty',
  'sec-fetch-mode': 'cors',
  'sec-fetch-site': 'same-origin',
  'user-agent': 'Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/133.0.0.0 Safari/537.36',
  'x-z-enable-oauth-conversion': 'true',
}

export interface ZillowListingDetailsOptions {
  timeoutMs?: number
  altFetch?: boolean
  onlyRemovedListings?: boolean
}

export const getZillowListingDetailsByZpid = async (zpid: string, options?: ZillowListingDetailsOptions) => {
  const { altFetch, onlyRemovedListings = false } = options ?? {}

  const response = (altFetch ? await fetchZillowListingDetailsByZpidAlt(zpid, options as ZillowListingDetailsOptions) : await fetchZillowListingDetailsByZpid(zpid, options as ZillowListingDetailsOptions)) || {}
  const { property, ...data } = response
  if (property) {
  // filter out unnecessary fields to shrink response
    const { buyAbilityData, collections, nearbyCities, nearbyNeighborhoods, nearbyZipcodes, schools, nearbyHomes, listingMetadata, homeInsights, responsivePhotos, submitFlow, contactFormRenderData, tourEligibility, onsiteMessage, ZoDsFsUpsellTop, streetViewMetadataUrlMapLightboxAddress, responsivePhotosOriginalRatio, thirdPartyVirtualTour, vrModel, topNavJson, ...response } = property || {}

    // return null if missing priceHistory
    if (!response?.priceHistory) {
      return null
    }

    // if onlyRemovedListings, only save listings that have been removed, do not save listings that are still for rent
    if (onlyRemovedListings) {
      const { homeStatus } = response ?? {}
      if (!homeStatus) {
        console.log('no home status', zpid)
        return null
      }

      // if homeStatus === 'FOR_RENT, do not save
      if (homeStatus === 'FOR_RENT') {
        const [recentPriceHistory] = response?.priceHistory ?? {}
        if (!recentPriceHistory?.event) {
          console.log('no recent price history')
        } else {
          console.log('recent price history not removed', zpid, recentPriceHistory?.event)
        }
        return null
      }
    }

    return {
      timestamp: dayjs(),
      ...response,
      ...data,
      ...(altFetch && { altFetch }),
    }
  }
}

const fetchZillowListingDetailsByZpid = async (zpid: string, options?: ZillowListingDetailsOptions) => {
  const { timeoutMs } = options ?? {}
  const baseUrl = 'https://www.zillow.com/graphql'
  const query = `?extensions=%7B%22persistedQuery%22%3A%7B%22version%22%3A1%2C%22sha256Hash%22%3A%222a50ebbffc7b6fb6e70fad24b7738df5db7f2ed5b61c2b980542749accff1f17%22%7D%7D&variables=%7B%22zpid%22%3A${zpid}%2C%22platform%22%3A%22DESKTOP_WEB%22%2C%22formType%22%3A%22OPAQUE%22%2C%22contactFormRenderParameter%22%3A%7B%22zpid%22%3A${zpid}%2C%22platform%22%3A%22desktop%22%2C%22isDoubleScroll%22%3Atrue%7D%2C%22skipCFRD%22%3Afalse%2C%22ompPlatform%22%3A%22web%22%7D`
  const url = `${baseUrl}${query}`

  const newAbortSignal = (timeoutMs: number) => {
    const abortController = new AbortController()
    setTimeout(() => abortController.abort(), timeoutMs || 0)
    return abortController.signal
  }

  const zillowCookie = await getZillowCookie()

  const headers = {
    ...zillowListingHeaders,
    cookie: zillowCookie,
  }
  const config = {
    headers,
    ...(timeoutMs && { signal: newAbortSignal(timeoutMs) }),
  }

  const { data } = await axios.get(url, config) || {}
  return data?.data
}

const fetchZillowListingDetailsByZpidAlt = async (zpid: string, { timeoutMs }: ZillowListingDetailsOptions) => {
  const baseUrl = 'https://www.zillow.com/graphql'
  const url = `${baseUrl}`

  const body = {
    operationName: 'ForRentShopperPlatformFullRenderQuery',
    variables: {
      zpid,
      altId: null,
    },
    query: 'query ForRentShopperPlatformFullRenderQuery($zpid: ID!, $altId: ID, $skipPropertyPrice: Boolean = false, $skipPropertyAddress: Boolean = false) {\n  property(zpid: $zpid, palsId: $altId) {\n    ...FrActionBarContent_property\n    ...FrMediaColumnContent_property\n    ...FrDataViewContent_property\n    ...PageViewTracker_property\n    ...FrSummaryContent_property\n    ...FrLightboxes_property\n    ...UniversalAnalyticsDataLayerFragment_property\n    ...ForRentSearchPageStateParamsFragment_property\n  }\n  viewer {\n    ...FrActionBarContent_viewer\n    ...FrSummaryContent_viewer\n    ...FrLightboxes_viewer\n    ...PageViewTracker_viewer\n  }\n  abTests {\n    HDP_RENTERS_INSURANCE_UPSELL: abTest(trial: "HDP_RENTERS_INSURANCE_UPSELL")\n    ACTIVATION_UPSELL_CONTENT: abTest(trial: "ACTIVATION_UPSELL_CONTENT")\n    Activation_Hollywood_Enabled: abTest(trial: "Activation_Hollywood_Enabled")\n    SI_CostsAndFees_Elevate_HDP_Web: abTest(\n      trial: "SI_CostsAndFees_Elevate_HDP_Web"\n    )\n    ...abTestManager_abTests\n    ...FrSummaryContent_abTests\n    ...DsNeighborhood_abTests\n    ...FrLightboxes_abTests\n    ...FrDataViewContent_abTests\n    ...UniversalAnalyticsDataLayerFragment_abTests\n    ...RentalContactForm_abTests_hdp\n    ...RentalPrequalificationCard\n  }\n}\n\nfragment FrActionBarContent_property on Property {\n  ...ActionBarController_property\n  ...EditRentalListing_property\n  ...ReleaseOwnership_property\n  ...EditPropertyHistory_property\n  ...CSPropertyUpdatePage_property\n  ...CSMoveHomeMapLocation_property\n  ...PropertyEventLog_property\n  ...ReportProblemLightbox_property\n}\n\nfragment ActionBarController_property on Property {\n  ...DsActionBar_property\n}\n\nfragment DsActionBar_property on Property {\n  zpid\n  city\n  state\n  homeStatus\n  ...SaveHome_property\n  ...SuperShareMenu_property\n}\n\nfragment SaveHome_property on Property {\n  address {\n    streetAddress\n    city\n    state\n    zipcode\n  }\n  homeStatus\n  isListingClaimedByCurrentSignedInUser\n  isCurrentSignedInAgentResponsible\n  zpid\n  bedrooms\n  bathrooms\n  price\n  yearBuilt\n}\n\nfragment SuperShareMenu_property on Property {\n  ...Share_property\n}\n\nfragment Share_property on Property {\n  zpid\n  streetAddress\n  city\n  state\n  zipcode\n  homeStatus\n}\n\nfragment EditRentalListing_property on Property {\n  listingAccount {\n    zuid\n  }\n  ssid\n  zpid\n}\n\nfragment ReleaseOwnership_property on Property {\n  zpid\n  isListingClaimedByCurrentSignedInUser\n  isCurrentSignedInUserVerifiedOwner\n}\n\nfragment EditPropertyHistory_property on Property {\n  editPropertyHistorylink\n}\n\nfragment CSPropertyUpdatePage_property on Property {\n  propertyUpdatePageLink\n}\n\nfragment CSMoveHomeMapLocation_property on Property {\n  moveHomeMapLocationLink\n}\n\nfragment PropertyEventLog_property on Property {\n  propertyEventLogLink\n}\n\nfragment ReportProblemLightbox_property on Property {\n  zpid\n  homeStatus\n}\n\nfragment FrActionBarContent_viewer on Viewer {\n  ...ActionBarController_viewer\n  ...ReportProblemLightbox_viewer\n}\n\nfragment ActionBarController_viewer on Viewer {\n  ...DsActionBar_viewer\n}\n\nfragment DsActionBar_viewer on Viewer {\n  email\n  ...SuperShareMenu_viewer\n}\n\nfragment SuperShareMenu_viewer on Viewer {\n  ...Share_viewer\n}\n\nfragment Share_viewer on Viewer {\n  email\n}\n\nfragment ReportProblemLightbox_viewer on Viewer {\n  email\n}\n\nfragment FrMediaColumnContent_property on Property {\n  ...FrMediaStream_property\n  ...FrPhotoCarousel_property\n}\n\nfragment FrMediaStream_property on Property {\n  responsivePhotos: photos {\n    caption\n    subjectType\n    url\n    mixedSources(aspectRatio: FourThirds) {\n      jpeg {\n        url\n        width\n      }\n      webp {\n        url\n        width\n      }\n    }\n  }\n  ...MediaStreamFloorMapTile_property\n  ...PanoramaTile_property\n  ...ThirdPartyVirtualTourTile_property\n  ...VideoTile_property\n  ...ContactUpsellTile_property\n  richMedia {\n    virtualTour {\n      vrModelGuid\n      revisionId\n      viewerUrl\n    }\n  }\n}\n\nfragment MediaStreamFloorMapTile_property on Property {\n  ...FloorMapTile_property\n  ...ShouldShowFloorMap_property\n  ...IMXLightboxEntryFragments_property\n}\n\nfragment FloorMapTile_property on Property {\n  richMedia {\n    floorPlan {\n      viewerUrl\n    }\n  }\n}\n\nfragment IMXLightboxEntryFragments_property on Property {\n  isShowcaseListing\n  ...IMXPhotoView_property\n  ...IMXRichMedia_property\n  ...IMXViewContainer_property\n  ...IMXViewMenu_property\n  ...SphereViewerListing_property\n}\n\nfragment IMXPhotoView_property on Property {\n  listingMetadata {\n    mustPreferMlsPhotos\n  }\n  originalPhotos: photos {\n    caption\n    mixedSources(aspectRatio: Original) {\n      jpeg {\n        url\n        width\n      }\n      webp {\n        url\n        width\n      }\n    }\n  }\n}\n\nfragment IMXRichMedia_property on Property {\n  richMedia {\n    imx {\n      viewerUrl\n      revisionId\n      hasLocalizedPhotos\n      isLmsTour\n    }\n  }\n}\n\nfragment IMXViewContainer_property on Property {\n  bedrooms\n  bathrooms\n  contingentListingType\n  homeStatus\n  listingSubType: listing_sub_type {\n    isFSBA: is_FSBA\n    isFSBO: is_FSBO\n    isPending: is_pending\n    isNewHome: is_newHome\n    isForeclosure: is_foreclosure\n    isBankOwned: is_bankOwned\n    isForAuction: is_forAuction\n    isOpenHouse: is_openHouse\n    isComingSoon: is_comingSoon\n  }\n  livingAreaValue\n  price @skip(if: $skipPropertyPrice)\n  ...IMXAttribution_property\n}\n\nfragment IMXAttribution_property on Property {\n  listingAccountUserId\n  attributionInfo {\n    agentName\n    agentEmail\n    agentPhoneNumber\n    brokerName\n    mlsId\n  }\n}\n\nfragment IMXViewMenu_property on Property {\n  isUndisclosedAddress\n  address @skip(if: $skipPropertyAddress) {\n    streetAddress\n    zipcode\n    city\n    state\n  }\n}\n\nfragment SphereViewerListing_property on Property {\n  streetAddress @skip(if: $skipPropertyAddress)\n  listingSubType: listing_sub_type {\n    isFSBA: is_FSBA\n    isPending: is_pending\n    isNewHome: is_newHome\n    isForeclosure: is_foreclosure\n    isBankOwned: is_bankOwned\n    isForAuction: is_forAuction\n    isOpenHouse: is_openHouse\n    isComingSoon: is_comingSoon\n  }\n  zpid\n  hdpUrl\n  tourViewCount\n}\n\nfragment ShouldShowFloorMap_property on Property {\n  homeStatus\n  richMedia {\n    floorPlan {\n      viewerUrl\n    }\n  }\n}\n\nfragment PanoramaTile_property on Property {\n  ...ShouldShowVirtualTour_property\n  ...SphereViewerContainer_property\n  ...IMXLightboxEntryFragments_property\n}\n\nfragment ShouldShowVirtualTour_property on Property {\n  homeStatus\n  richMedia {\n    virtualTour {\n      viewerUrl\n      revisionId\n    }\n  }\n}\n\nfragment SphereViewerContainer_property on Property {\n  ...SphereViewerListing_property\n  ...SphereViewerAttribution_property\n  ...SphereViewerVrModel_property\n}\n\nfragment SphereViewerAttribution_property on Property {\n  postingContact {\n    name\n    photo(size: PROFILE_120_120) {\n      url\n    }\n  }\n}\n\nfragment SphereViewerVrModel_property on Property {\n  vrModel {\n    vrModelGuid\n    revisionId\n  }\n  richMedia {\n    virtualTour {\n      viewerUrl\n      revisionId\n    }\n  }\n}\n\nfragment ThirdPartyVirtualTourTile_property on Property {\n  thirdPartyVirtualTour {\n    externalUrl\n    lightboxUrl\n    staticUrl\n    providerKey\n  }\n  ...couldShowThirdPartyVirtualTour_property\n}\n\nfragment couldShowThirdPartyVirtualTour_property on Property {\n  homeStatus\n  hasApprovedThirdPartyVirtualTourUrl\n  thirdPartyVirtualTour {\n    approved\n  }\n}\n\nfragment VideoTile_property on Property {\n  streetAddress\n  description\n  primaryPublicVideo {\n    sourceVideoWidth\n    sourceVideoHeight\n    videoDurationSeconds\n    createdAt\n    sources {\n      src\n      type\n    }\n  }\n  richMediaVideos {\n    mp4Url\n    hlsUrl\n  }\n  ...ShouldShowVideo_property\n}\n\nfragment ShouldShowVideo_property on Property {\n  homeStatus\n  isZillowOwned\n  hasPublicVideo\n  primaryPublicVideo {\n    sources {\n      src\n    }\n  }\n  richMediaVideos {\n    mp4Url\n    hlsUrl\n  }\n}\n\nfragment ContactUpsellTile_property on Property {\n  ...HomeDetailsContactUpsell_property\n}\n\nfragment HomeDetailsContactUpsell_property on Property {\n  ...DsContactButtons_property\n}\n\nfragment DsContactButtons_property on Property {\n  zpid\n  listing_sub_type {\n    is_FSBA\n    is_FSBO\n  }\n  state\n  ...DsGetAuctionDetailsButton_property\n}\n\nfragment DsGetAuctionDetailsButton_property on Property {\n  postingUrl\n}\n\nfragment FrPhotoCarousel_property on Property {\n  ...getPhotoTiles_property\n  ...PanoUpsellTile_property\n  ...MultiMediaEntryPoint_property\n}\n\nfragment getPhotoTiles_property on Property {\n  responsivePhotos: photos {\n    caption\n    mixedSources(aspectRatio: FourThirds) {\n      jpeg {\n        url\n        width\n      }\n      webp {\n        url\n        width\n      }\n    }\n  }\n}\n\nfragment PanoUpsellTile_property on Property {\n  ...ShouldShowVirtualTour_property\n}\n\nfragment MultiMediaEntryPoint_property on Property {\n  zpid\n  ...ShouldShowFloorMap_property\n  ...ShouldShowVideo_property\n  ...ShouldShowVirtualTour_property\n}\n\nfragment FrDataViewContent_property on Property {\n  isListingOwnedByCurrentSignedInUser\n  ...FrCollections_property\n  ...ForRentFactsAndFeatures_property\n  ...ServicesAvailable_property\n  ...DsHomeValue_property\n  ...DsPriceAndTaxHistory_property\n  ...DsNearbySchools_property\n  ...DsNeighborhood_property\n  ...DsNearbyApartments_property\n  ...FrOverview_property\n  ...FrSpecialOffers_property\n  ...ListingProvidedBy_property\n  ...DsRentalFooterSection_property\n  ...BdpModule_property\n  ...FrOnsiteMessage_property\n  ...GetShareWithCaseManagerEnabled_property\n  ...IsPropertyAndViewerEnrolledInLlp_property\n  ...IsRoomForRent_property\n  ...AgentSignature_property\n}\n\nfragment FrCollections_property on Property {\n  collections(\n    cExperienceId: "zFRHDP"\n    contentTypes: [FOR_RENT]\n    placements: [NEIGHBORHOOD]\n  ) {\n    modules {\n      ... on Collection {\n        name\n        placement\n        propertyDetails {\n          ...DsMiniCard_property\n        }\n      }\n    }\n    trackingTags {\n      value\n    }\n  }\n  providerListingID\n  zpid\n}\n\nfragment DsMiniCard_property on Property {\n  miniCardPhotos: photos(count: 1, size: S) {\n    url\n  }\n  ...DsMiniCardCommon_property\n}\n\nfragment DsMiniCardCommon_property on Property {\n  price\n  currency\n  bedrooms\n  bathrooms\n  livingArea\n  livingAreaValue\n  livingAreaUnits\n  livingAreaUnitsShort\n  listingMetadata {\n    comminglingCategoryIsRulesApplicable\n  }\n  lotSize\n  lotAreaValue\n  lotAreaUnits\n  address {\n    streetAddress\n    city\n    state\n    zipcode\n  }\n  parentRegion {\n    name\n  }\n  formattedChip(xConsumerUsername: "hdp-web") {\n    location {\n      fullValue\n    }\n  }\n  latitude\n  longitude\n  zpid\n  homeStatus\n  homeType\n  hdpUrl\n  hdpTypeDimension\n  propertyTypeDimension\n  listingTypeDimension\n  listing_sub_type {\n    is_newHome\n    is_forAuction\n    is_bankOwned\n    is_foreclosure\n    is_FSBO\n    is_comingSoon\n  }\n  providerListingID\n  attributionInfo {\n    mlsId\n    mlsName\n    providerLogo\n    agentName\n    agentPhoneNumber\n    brokerName\n    brokerPhoneNumber\n    trueStatus\n  }\n  ...Variant_property\n  ...NcVariant_property\n}\n\nfragment Variant_property on Property {\n  isShowcaseListing\n  isPremierBuilder\n  homeStatus\n  listing_sub_type {\n    is_FSBO\n    is_FSBA\n    is_newHome\n    is_foreclosure\n    is_bankOwned\n    is_forAuction\n    is_comingSoon\n  }\n  zpid\n  state\n}\n\nfragment NcVariant_property on Property {\n  isPremierBuilder\n  newConstructionType\n}\n\nfragment ForRentFactsAndFeatures_property on Property {\n  ...ForRentFactsAndFeaturesInitialRender_property\n  ...IsRoomForRent_property\n  roomForRent {\n    leaseDetails {\n      leaseTerm\n      leaseDescription\n    }\n    roomDetails {\n      utilitiesShareDescription\n      hasPrivateBath\n      roomIsFurnished\n    }\n    roommateDetails {\n      roommateGenderDetails {\n        type\n        genderCount\n      }\n      totalCount\n      roommatePetDetails {\n        type\n        petCount\n      }\n    }\n    roommateRequirements {\n      genderTypes\n    }\n  }\n}\n\nfragment ForRentFactsAndFeaturesInitialRender_property on Property {\n  ...FactsAndFeaturesCommon_property\n  listPriceLow\n  timeOnZillow\n  resoFacts {\n    constructionMaterials\n    exteriorFeatures\n    livingAreaRangeUnits\n    allowedPets\n    leaseTerm\n    petsMaxWeight\n    tenantPays\n    virtualTour\n    availabilityDate\n  }\n}\n\nfragment FactsAndFeaturesCommon_property on Property {\n  state\n  attributionInfo {\n    listingAgreement\n  }\n  currency\n  homeStatus\n  homeType\n  interactiveFloorPlanUrl\n  lotPremium\n  listPriceLow\n  price\n  resoFacts {\n    aboveGradeFinishedArea\n    accessibilityFeatures\n    additionalFeeInfo\n    additionalParcelsDescription\n    architecturalStyle\n    associations {\n      feeFrequency\n      name\n      phone\n    }\n    associationFee\n    associationAmenities\n    associationFee2\n    associationFeeIncludes\n    associationName\n    associationName2\n    associationPhone\n    associationPhone2\n    basementYN\n    buildingFeatures\n    buildingName\n    appliances\n    atAGlanceFacts {\n      factLabel\n      factValue\n    }\n    attic\n    availabilityDate\n    basement\n    bathrooms\n    bathroomsFull\n    bathroomsHalf\n    bathroomsOneQuarter\n    bathroomsPartial\n    bathroomsFloat\n    bathroomsThreeQuarter\n    bedrooms\n    belowGradeFinishedArea\n    bodyType\n    builderModel\n    builderName\n    buildingArea\n    buildingAreaSource\n    canRaiseHorses\n    carportParkingCapacity\n    cityRegion\n    commonWalls\n    communityFeatures\n    compensationBasedOn\n    constructionMaterials\n    contingency\n    cooling\n    coveredParkingCapacity\n    cropsIncludedYN\n    cumulativeDaysOnMarket\n    developmentStatus\n    doorFeatures\n    electric\n    elevation\n    elevationUnits\n    entryLevel\n    entryLocation\n    exclusions\n    exteriorFeatures\n    feesAndDues {\n      type\n      fee\n      name\n      phone\n    }\n    fencing\n    fireplaceFeatures\n    fireplaces\n    flooring\n    foundationArea\n    foundationDetails\n    frontageLength\n    frontageType\n    furnished\n    garageParkingCapacity\n    gas\n    greenBuildingVerificationType\n    greenEnergyEfficient\n    greenEnergyGeneration\n    greenIndoorAirQuality\n    greenSustainability\n    greenWaterConservation\n    hasAdditionalParcels\n    hasAssociation\n    hasAttachedGarage\n    hasAttachedProperty\n    hasCooling\n    hasCarport\n    hasElectricOnProperty\n    hasFireplace\n    hasGarage\n    hasHeating\n    hasHomeWarranty\n    hasLandLease\n    hasOpenParking\n    hasRentControl\n    hasSpa\n    hasPetsAllowed\n    hasPrivatePool\n    hasView\n    hasWaterfrontView\n    heating\n    highSchool\n    highSchoolDistrict\n    hoaFee\n    hoaFeeTotal\n    homeType\n    horseAmenities\n    horseYN\n    inclusions\n    incomeIncludes\n    interiorFeatures\n    irrigationWaterRightsAcres\n    irrigationWaterRightsYN\n    isNewConstruction\n    isSeniorCommunity\n    landLeaseAmount\n    landLeaseExpirationDate\n    laundryFeatures\n    leaseTerm\n    levels\n    listingId\n    listingTerms\n    lotFeatures\n    lotSize\n    lotSizeDimensions\n    livingArea\n    livingAreaRange\n    livingAreaRangeUnits\n    livingQuarters {\n      livingArea\n      livingAreaUnits\n      areaTotal\n      areaTotalUnits\n      features\n      livingQuarterType\n    }\n    mainLevelBathrooms\n    mainLevelBedrooms\n    marketingType\n    media {\n      mediaCategory\n      mediaURL\n    }\n    middleOrJuniorSchool\n    middleOrJuniorSchoolDistrict\n    municipality\n    numberOfUnitsInCommunity\n    numberOfUnitsVacant\n    offerReviewDate\n    onMarketDate\n    openParkingCapacity\n    otherEquipment\n    otherFacts {\n      name\n      value\n    }\n    otherParking\n    otherStructures\n    ownership\n    ownershipType\n    parcelNumber\n    parkingCapacity\n    parkingFeatures\n    parkName\n    patioAndPorchFeatures\n    petsMaxWeight\n    poolFeatures\n    pricePerSquareFoot\n    propertyCondition\n    propertySubType\n    roadSurfaceType\n    roofType\n    rooms {\n      area\n      description\n      dimensions\n      level\n      features\n      roomArea\n      roomAreaSource\n      roomAreaUnits\n      roomDescription\n      roomDimensions\n      roomFeatures\n      roomLength\n      roomLengthWidthSource\n      roomLengthWidthUnits\n      roomLevel\n      roomType\n      roomWidth\n    }\n    roomTypes\n    securityFeatures\n    sewer\n    spaFeatures\n    specialListingConditions\n    stories\n    storiesDecimal\n    storiesTotal\n    structureType\n    subdivisionName\n    taxAnnualAmount\n    taxAssessedValue\n    tenantPays\n    topography\n    totalActualRent\n    utilities\n    vegetation\n    view\n    virtualTour\n    waterSource\n    waterBodyName\n    waterfrontFeatures\n    waterView\n    waterViewYN\n    windowFeatures\n    woodedArea\n    yearBuilt\n    yearBuiltEffective\n    zoning\n    zoningDescription\n  }\n}\n\nfragment IsRoomForRent_property on Property {\n  listing_sub_type {\n    is_roomForRent\n  }\n}\n\nfragment ServicesAvailable_property on Property {\n  adTargets\n}\n\nfragment DsHomeValue_property on Property {\n  country\n  ...SecondGenHomeValue_property\n}\n\nfragment SecondGenHomeValue_property on Property {\n  country\n  ...DsMessagePrompt_property\n  ...SecondGenZestimateSummary_property\n}\n\nfragment SecondGenZestimateSummary_property on Property {\n  zpid\n  ...SecondGenZestimateRange_property\n}\n\nfragment SecondGenZestimateRange_property on Property {\n  zestimate\n  zestimateLowPercent\n  zestimateHighPercent\n  rentZestimate\n  restimateLowPercent\n  restimateHighPercent\n}\n\nfragment DsMessagePrompt_property on Property {\n  zpid\n  yearBuilt\n  livingArea\n  livingAreaValue\n  bathrooms\n  bedrooms\n  homeType\n  zestimate\n  price\n  homeStatus\n  ...NcVariant_property\n}\n\nfragment DsPriceAndTaxHistory_property on Property {\n  zpid\n  countyFIPS\n  parcelId\n  taxHistory {\n    time\n    taxPaid\n    taxIncreaseRate\n    value\n    valueIncreaseRate\n  }\n  priceHistory {\n    date\n    time\n    price\n    pricePerSquareFoot\n    priceChangeRate\n    event\n    source\n    buyerAgent {\n      photo {\n        url\n      }\n      profileUrl\n      name\n    }\n    sellerAgent {\n      photo {\n        url\n      }\n      profileUrl\n      name\n    }\n    showCountyLink\n    postingIsRental\n    attributeSource {\n      infoString1\n      infoString2\n      infoString3\n    }\n  }\n  currency\n  country\n  listing_sub_type {\n    is_forAuction\n    is_comingSoon\n  }\n}\n\nfragment DsNearbySchools_property on Property {\n  country\n  state\n  schools {\n    distance\n    name\n    rating\n    level\n    studentsPerTeacher\n    assigned\n    grades\n    link\n    type\n    size\n    totalCount\n    assigned\n    isAssigned\n  }\n  citySearchUrl {\n    text\n  }\n  ...DsResoSchools_property\n}\n\nfragment DsResoSchools_property on Property {\n  isPremierBuilder\n  resoFacts {\n    elementarySchool\n    middleOrJuniorSchool\n    highSchool\n    elementarySchoolDistrict\n  }\n  attributionInfo {\n    mlsName\n  }\n}\n\nfragment DsNeighborhood_property on Property {\n  adTargets\n  ...DsNeighborhoodIncludingNearbyHomes_property\n}\n\nfragment DsNeighborhoodIncludingNearbyHomes_property on Property {\n  ...DsNeighborhoodCommon_property\n  nearbyHomes(count: 8) {\n    ...DsMiniCardGallery_property\n    ...DsMiniCardCarousel_property\n  }\n}\n\nfragment DsNeighborhoodCommon_property on Property {\n  homeStatus\n  price\n  rentZestimate\n  zestimate\n  homeValues {\n    region {\n      shortName\n      link\n      zhvi {\n        yoy\n        value\n      }\n      zhviForecast {\n        value\n      }\n    }\n  }\n  address {\n    zipcode\n  }\n  parentRegion {\n    name\n  }\n}\n\nfragment DsMiniCardGallery_property on Property {\n  zpid\n  ...DsMiniCard_property\n}\n\nfragment DsMiniCardCarousel_property on Property {\n  zpid\n  ...DsMiniCard_property\n}\n\nfragment DsNearbyApartments_property on Property {\n  zpid\n  nearbyBuildings {\n    bdpLink\n    bedroomGroups {\n      beds\n    }\n    buildingAddress\n    buildingName\n    lotId\n    latitude\n    longitude\n    maxPrice\n    minBaths\n    minBeds\n    minLivingArea\n    minPrice\n    photo {\n      url\n    }\n    photoCount\n    showUpdateTime\n    listingMetadata {\n      BuildingDataG\n      BuildingDataH\n      BuildingDataI\n      BuildingDataJ\n      BuildingDataL\n      BuildingDataM\n      BuildingDataN\n      BuildingDataO\n      BuildingDataP\n    }\n    providerListingId\n  }\n}\n\nfragment FrOverview_property on Property {\n  state\n  city\n  zpid\n  description\n  isHousingConnector\n  isIncomeRestricted\n  rentalMarketingTreatments\n  building {\n    buildingName\n    bdpUrl\n    rentalUnitsSummary {\n      unitCount\n    }\n  }\n  daysOnZillow\n  rentalApplicationsAcceptedType\n  postingProductType\n  ...InsightsTags_property\n  ...DsVirtualOpenHouse_property\n  ...DsOpenHouseCalendar_property\n  ...CommuteWithMapFallback_property\n  ...GetShareWithCaseManagerEnabled_property\n  ...IsPropertyAndViewerEnrolledInLlp_property\n  ...RoomFrOverviewSection_property\n  ...IsRoomForRent_property\n  ...RentalStats_property\n}\n\nfragment InsightsTags_property on Property {\n  homeInsights {\n    insights {\n      modelId\n      treatmentId\n      phrases\n    }\n  }\n}\n\nfragment DsVirtualOpenHouse_property on Property {\n  timeZone\n  resoFacts {\n    otherFacts {\n      value\n      name\n    }\n  }\n  address {\n    streetAddress\n    city\n    state\n    zipcode\n  }\n}\n\nfragment DsOpenHouseCalendar_property on Property {\n  latitude\n  longitude\n  country\n  address {\n    streetAddress\n    city\n    state\n    zipcode\n  }\n  zpid\n  hdpUrl\n  openHouseSchedule {\n    startTime\n    endTime\n  }\n  desktopWebHdpImageLink\n  price\n  currency\n  brokerageName\n  homeStatus\n}\n\nfragment CommuteWithMapFallback_property on Property {\n  ...SecondGenCommute_property\n  ...MapAndStreetViewTile_property\n}\n\nfragment SecondGenCommute_property on Property {\n  latitude\n  longitude\n}\n\nfragment MapAndStreetViewTile_property on Property {\n  hasBadGeocode\n  ...GoogleStreetViewTile_property\n  ...StaticMap_property\n}\n\nfragment GoogleStreetViewTile_property on Property {\n  zpid\n  longitude\n  latitude\n  listing_sub_type {\n    is_FSBA\n    is_newHome\n  }\n  streetViewMetadataUrlMediaWallLatLong: googleStreetViewMetadataSignedUrl(\n    featureArea: "hdpMediaWall"\n    locationType: LAT_LONG\n  )\n  streetViewMetadataUrlMediaWallAddress: googleStreetViewMetadataSignedUrl(\n    featureArea: "hdpMediaWall"\n    locationType: ADDRESS\n  )\n  streetViewTileImageUrlMediumLatLong: googleStreetViewImageSignedUrl(\n    featureArea: "hdpMediaWall"\n    locationType: LAT_LONG\n    width: 400\n    height: 250\n  )\n  streetViewTileImageUrlMediumAddress: googleStreetViewImageSignedUrl(\n    featureArea: "hdpMediaWall"\n    locationType: ADDRESS\n    width: 400\n    height: 250\n  )\n  streetViewServiceUrl: streetViewServiceUrl(\n    featureArea: "hdpMediaWall"\n    width: 512\n    height: 234\n  )\n}\n\nfragment StaticMap_property on Property {\n  staticMap(\n    featureArea: "hdpMediaWall"\n    shouldGetAdditionalHighResSources: true\n    zoom: 15\n  ) {\n    sources(aspectRatio: FourThirds, minWidth: 150, maxWidth: 768) {\n      width\n      url\n      isHighResolutionStaticMap\n    }\n  }\n}\n\nfragment GetShareWithCaseManagerEnabled_property on Property {\n  isHousingConnector\n  homeStatus\n}\n\nfragment IsPropertyAndViewerEnrolledInLlp_property on Property {\n  isHousingConnector\n}\n\nfragment RoomFrOverviewSection_property on Property {\n  description\n  roomForRent {\n    postedBy\n    roommateDetails {\n      description\n    }\n  }\n}\n\nfragment RentalStats_property on Property {\n  ...IsRoomForRent_property\n}\n\nfragment FrSpecialOffers_property on Property {\n  specialOffers {\n    description\n    startDate\n    endDate\n  }\n}\n\nfragment ListingProvidedBy_property on Property {\n  listingProvider {\n    title\n    disclaimerText\n    enhancedVideoURL\n    enhancedDescriptionText\n    showLogos\n    logos {\n      src\n      link\n    }\n    showNoContactInfoMessage\n    agentName\n    agentLicenseNumber\n    postingWebsiteURL\n    postingWebsiteLinkText\n    postingGroupName\n    sourceText\n    isZRMSourceText\n  }\n  zpid\n  isIncomeRestricted\n  listing_sub_type {\n    is_newHome\n    is_FSBA\n    is_comingSoon\n    is_forAuction\n  }\n  brokerId\n  ssid\n  attributionInfo {\n    listingAttributionContact\n    listingAgentAttributionContact\n    infoString3\n    infoString5\n    infoString10\n    infoString16\n    providerLogo\n    agentPhoneNumber\n    mlsDisclaimer\n    agentEmail\n    brokerPhoneNumber\n  }\n  state\n  homeStatus\n  ...NcVariant_property\n}\n\nfragment DsRentalFooterSection_property on Property {\n  ...Comscore_property\n  ...DsRentalFooter_property\n  ...DsBreadcrumbs_property\n  adTargets\n}\n\nfragment Comscore_property on Property {\n  zpid\n  address {\n    streetAddress\n    state\n    city\n    zipcode\n  }\n  hdpUrl\n}\n\nfragment DsRentalFooter_property on Property {\n  listing_sub_type {\n    is_newHome\n  }\n  ...NearbyCitiesColumn_property\n  ...NearbyNeighborhoodsColumn_property\n  ...NearbyZipcodesColumn_property\n  ...DsNearbyBuildingsColumn_property\n}\n\nfragment NearbyCitiesColumn_property on Property {\n  nearbyCities {\n    regionUrl {\n      path\n    }\n    name\n    body {\n      city\n      state\n    }\n  }\n}\n\nfragment NearbyNeighborhoodsColumn_property on Property {\n  nearbyNeighborhoods {\n    regionUrl {\n      path\n    }\n    name\n    body {\n      neighborhood\n      city\n      state\n    }\n  }\n}\n\nfragment NearbyZipcodesColumn_property on Property {\n  country\n  nearbyZipcodes {\n    regionUrl {\n      path\n    }\n    name\n    body {\n      zipcode\n      city\n      state\n    }\n  }\n}\n\nfragment DsNearbyBuildingsColumn_property on Property {\n  nearbyBuildingLinks {\n    buildingUrl {\n      path\n      text\n    }\n  }\n}\n\nfragment DsBreadcrumbs_property on Property {\n  ...Breadcrumbs_property\n}\n\nfragment Breadcrumbs_property on Property {\n  streetAddress\n  abbreviatedAddress\n  city\n  state\n  county\n  zipcode\n  address {\n    neighborhood\n    community\n    subdivision\n  }\n  neighborhoodRegion {\n    name\n  }\n  building {\n    bdpUrl\n    buildingName\n  }\n  isUndisclosedAddress\n  boroughId\n  providerListingID\n  neighborhoodSearchUrl {\n    path\n  }\n  stateSearchUrl {\n    path\n  }\n  countySearchUrl {\n    text\n    path\n  }\n  citySearchUrl {\n    text\n    path\n  }\n  zipcodeSearchUrl {\n    path\n  }\n  boroughSearchUrl {\n    text\n    path\n  }\n  communityUrl {\n    path\n  }\n  ...Variant_property\n}\n\nfragment FrOnsiteMessage_property on Property {\n  onsiteMessage(placementNames: ["FRHDPTopSlot"]) {\n    eventId\n    decisionContext\n    messages {\n      skipDisplayReason\n      shouldDisplay\n      isGlobalHoldout\n      isPlacementHoldout\n      placementName\n      testPhase\n      bucket\n      placementId\n      passThrottle\n      lastModified\n      eventId\n      decisionContext\n      selectedTreatment {\n        id\n        name\n        component\n        status\n        renderingProps\n        lastModified\n      }\n      qualifiedTreatments {\n        id\n        name\n        status\n        lastModified\n      }\n    }\n  }\n}\n\nfragment BdpModule_property on Property {\n  building {\n    buildingName\n    bdpUrl\n    streetAddress\n    rentalUnitsSummary {\n      unitCount\n    }\n  }\n}\n\nfragment AgentSignature_property on Property {\n  isListedByOwner\n  roomForRent {\n    postedBy\n  }\n}\n\nfragment FrDataViewContent_abTests on ABTests {\n  ...FrOverview_abTests\n  SEOTEST_REMOVE_RENT_ZESTIMATE: abTest(trial: "SEOTEST_REMOVE_RENT_ZESTIMATE")\n  ...IsRoomForRent_abTests\n  ...RentalUpsellContainer_abTests\n  ...DsRentalFooterSection_abTests\n  ...AtAGlanceFactsWrapper_abTests\n  ...HousingVoucherABTests_abTests\n  ...HomeDetailsListingCriteriaCard_abTests\n  SI_CostAndFees_HDP_Triage: abTest(trial: "SI_CostAndFees_HDP_Triage")\n}\n\nfragment FrOverview_abTests on ABTests {\n  ...RentalStats_abTests\n  ...IsRoomForRent_abTests\n  ...HomeDetailsRentalsAgentCard_abTests\n}\n\nfragment RentalStats_abTests on ABTests {\n  RE_HDP_Reputation_Data: abTest(trial: "RE_HDP_Reputation_Data")\n  ...IsRoomForRent_abTests\n}\n\nfragment IsRoomForRent_abTests on ABTests {\n  RE_R4R_SRP: abTest(trial: "RE_R4R_SRP")\n}\n\nfragment HomeDetailsRentalsAgentCard_abTests on ABTests {\n  AGENT_CARD_TCPA_DISCLAIMER: abTest(trial: "AGENT_CARD_TCPA_DISCLAIMER")\n}\n\nfragment AtAGlanceFactsWrapper_abTests on ABTests {\n  RE_HDP_AGENT_INFO: abTest(trial: "RE_HDP_AGENT_INFO")\n}\n\nfragment RentalUpsellContainer_abTests on ABTests {\n  RE_UPDATE_APPLICATION_UPSELL_PRICING: abTest(\n    trial: "RE_UPDATE_APPLICATION_UPSELL_PRICING"\n  )\n}\n\nfragment DsRentalFooterSection_abTests on ABTests {\n  RE_ARCANE_HDP: abTest(trial: "RE_ARCANE_HDP")\n}\n\nfragment HousingVoucherABTests_abTests on ABTests {\n  ...HousingVoucher_abTests\n}\n\nfragment HousingVoucher_abTests on ABTests {\n  SI_Housing_Voucher_Tips: abTest(trial: "SI_Housing_Voucher_Tips")\n}\n\nfragment HomeDetailsListingCriteriaCard_abTests on ABTests {\n  RE_LISTING_CRITERIA: abTest(trial: "RE_LISTING_CRITERIA")\n  RC_LISTING_CRITERIA_PET_POLICY_UPDATE: abTest(\n    trial: "RC_LISTING_CRITERIA_PET_POLICY_UPDATE"\n  )\n}\n\nfragment PageViewTracker_property on Property {\n  zpid\n  address {\n    streetAddress\n    state\n    city\n    zipcode\n    neighborhood\n  }\n  zestimate\n  hdpUrl\n  price\n  homeType\n  homeStatus\n  listing_sub_type {\n    is_pending\n    is_comingSoon\n    is_FSBO\n    is_bankOwned\n    is_newHome\n    is_foreclosure\n    is_forAuction\n    is_FSBA\n  }\n  isRecentStatusChange\n  isNonOwnerOccupied\n  brokerId\n  ssid\n  buildingId\n  county\n  newConstructionType\n  daysOnZillow\n  latitude\n  longitude\n  bedrooms\n  bathrooms\n  livingArea\n  livingAreaValue\n  lotSize\n  lotAreaValue\n  yearBuilt\n  foreclosureTypes {\n    isBankOwned\n    wasNonRetailAuction\n    wasDefault\n  }\n  isFeatured\n  postingUrl\n  providerListingID\n  isPremierBuilder\n  rentalApplicationsAcceptedType\n  brokerageName\n  currency\n  propertyTypeDimension\n  hdpTypeDimension\n  listingTypeDimension\n  featuredListingTypeDimension\n  brokerIdDimension\n  keystoneHomeStatus\n  pageUrlFragment\n  contingentListingType\n  isRentalsLeadCapMet\n  isPaidMultiFamilyBrokerId\n  timeZone\n  resoFacts {\n    otherFacts {\n      value\n      name\n    }\n  }\n  tourEligibility(\n    platform: WEB\n    useAsyncAb: false\n    supportedTourTypes: [STANDARD, INSTANT, INSTANT_BOOK]\n  ) {\n    isPropertyTourEligible\n  }\n  virtualTourUrl\n  bedrooms\n  bathrooms\n  ...IMXRichMedia_property\n  ...NcVariant_property\n  ...ShouldShowFloorMap_property\n  ...ShouldShowVideo_property\n  ...ShouldShowVirtualTour_property\n  ...couldShowThirdPartyVirtualTour_property\n  ...couldShowEmbeddedThirdPartyVirtualTour_property\n}\n\nfragment couldShowEmbeddedThirdPartyVirtualTour_property on Property {\n  thirdPartyVirtualTour {\n    lightboxUrl\n  }\n  ...couldShowThirdPartyVirtualTour_property\n}\n\nfragment PageViewTracker_viewer on Viewer {\n  emailHash\n}\n\nfragment abTestManager_abTests on ABTests {\n  AB_DASHBOARD_AA_TEST: abTest(trial: "AB_DASHBOARD_AA_TEST")\n  ACTIVATION_ENABLED: abTest(trial: "Activation_Enabled")\n  ACTIVATION_ONBOARDING: abTest(trial: "Activation_Onboarding")\n  ACTIVATION_ONBOARDING_ENABLED: abTest(trial: "Activation_Onboarding_Enabled")\n  ACTIVATION_GA_METRICS_ENABLED: abTest(trial: "Activation_GA_Metrics_Enabled")\n  AIPERS_SIMILAR_HOMES_GDP: abTest(trial: "AIPERS_SIMILAR_HOMES_GDP")\n  AR_CSAT_ONSITE_HDP: abTest(trial: "AR_CSAT_ONSITE_HDP")\n  AR_CSAT_MODAL_HDP_LOAD_DELAY: abTest(trial: "AR_CSAT_MODAL_HDP_LOAD_DELAY")\n  AR_SHOWCASE_HDP_WIDGET: abTest(trial: "AR_SHOWCASE_HDP_WIDGET")\n  HDP_CONSTELLATION_PROPERTY_CARD: abTest(\n    trial: "HDP_CONSTELLATION_PROPERTY_CARD"\n  )\n  HDP_DESKTOP_LAYOUT_TOPNAV: abTest(trial: "HDP_DESKTOP_LAYOUT_TOPNAV")\n  HDP_EARLY_TRIAGE_REORDER: abTest(trial: "HDP_EARLY_TRIAGE_REORDER")\n  HDP_EARLY_TRIAGE_REORDER_APP: abTest(trial: "HDP_EARLY_TRIAGE_REORDER_APP")\n  HDP_FNF_BULLETS: abTest(trial: "HDP_FNF_BULLETS")\n  HDP_HFF_ACCORDION: abTest(trial: "HDP_HFF_ACCORDION")\n  HDP_HIGHLIGHT_OFFER_REVIEW: abTest(trial: "HDP_HIGHLIGHT_OFFER_REVIEW")\n  HDP_HOLLYWOOD_FS_SUBTYPES: abTest(trial: "HDP_HOLLYWOOD_FS_SUBTYPES")\n  HDP_HOME_INSIGHTS: abTest(trial: "HDP_HOME_INSIGHTS")\n  HDP_INSIGHTS_VERSION: abTest(trial: "HDP_INSIGHTS_VERSION")\n  HDP_REORDER_AT_A_GLANCE: abTest(trial: "HDP_REORDER_AT_A_GLANCE")\n  HDP_SELLING_SOON_MSG: abTest(trial: "HDP_SELLING_SOON_MSG")\n  HDP_SELLING_SOON_V2_TEST: abTest(trial: "HDP_SELLING_SOON_V2_TEST")\n  HDP_TOP_SLOT: abTest(trial: "HDP_TOP_SLOT")\n  HDP_UPDATED_FNF: abTest(trial: "HDP_UPDATED_FNF")\n  HDP_ZHVI_CHART_MIGRATION: abTest(trial: "HDP_ZHVI_CHART_MIGRATION")\n  MIGHTY_MONTH_2022_HOLDOUT: abTest(trial: "MIGHTY_MONTH_2022_HOLDOUT")\n  MTT_GDP_PVS_CALL_GATE: abTest(trial: "MTT_GDP_PVS_CALL_GATE")\n  NFSHDP_OWNER_OPTIONS_GOOGLE_AD: abTest(trial: "NFSHDP_OWNER_OPTIONS_GOOGLE_AD")\n  PERF_DEFER_PHOTOS: abTest(trial: "PERF_DEFER_PHOTOS")\n  PERF_PRELOAD_HDP_IMAGE: abTest(trial: "PERF_PRELOAD_HDP_IMAGE")\n  RE_CANADA_CTA: abTest(trial: "RE_CANADA_CTA")\n  RE_HDP_HOME_INSIGHTS: abTest(trial: "RE_HDP_HOME_INSIGHTS")\n  RE_HDP_HOME_INSIGHTS_VERSION: abTest(trial: "RE_HDP_HOME_INSIGHTS_VERSION")\n  RE_VARIANT_HDP_DEFERRED_HYDRATION: abTest(\n    trial: "RE_VARIANT_HDP_DEFERRED_HYDRATION"\n  )\n  RE_NON_VARIANT_HDP_DEFERRED_HYDRATION: abTest(\n    trial: "RE_NON_VARIANT_HDP_DEFERRED_HYDRATION"\n  )\n  SI_DownPaymentAssistance: abTest(trial: "SI_DownPaymentAssistance")\n  SI_DPA_Apps: abTest(trial: "SI_DPA_Apps")\n  SI_CostAndFees_HDP_Triage: abTest(trial: "SI_CostAndFees_HDP_Triage")\n  SPT_RENDER_FOR_RENT_PAGE: abTest(trial: "SPT_RENDER_FOR_RENT_PAGE")\n  TRACK_HOME_VALUE_V1: abTest(trial: "TRACK_HOME_VALUE_V1")\n  UnassistedHomeShowingWeb: abTest(trial: "UnassistedHomeShowingWeb")\n  SPT_RENDER_FOR_SALE_PAGE: abTest(trial: "SPT_RENDER_FOR_SALE_PAGE")\n  VL_BDP_NEW_TAB: abTest(trial: "VL_BDP_NEW_TAB")\n  HDP_NEW_ZESTIMATE_CHART: abTest(trial: "HDP_NEW_ZESTIMATE_CHART")\n  ZEXP_HOLDOUT_ES_PILOT: abTest(trial: "ZEXP_HOLDOUT_ES_PILOT")\n  ZHL_HDP_CHIP_PERSONALIZE_PAYMENT_CTAS: abTest(\n    trial: "ZHL_HDP_CHIP_PERSONALIZE_PAYMENT_CTAS"\n  )\n  ZHL_HDP_CHIP_PERSONALIZE_PAYMENT_PERSISTENCE: abTest(\n    trial: "ZHL_HDP_CHIP_PERSONALIZE_PAYMENT_PERSISTENCE"\n  )\n  ZHL_PERSONALIZED_PAYMENT_WEB_MVP: abTest(\n    trial: "ZHL_PERSONALIZED_PAYMENT_WEB_MVP"\n  )\n  ZHL_PERSONALIZED_PAYMENT_MODULE: abTest(\n    trial: "ZHL_PERSONALIZED_PAYMENT_MODULE"\n  )\n}\n\nfragment FrSummaryContent_property on Property {\n  ...FrChip_property\n  ...GetShareWithCaseManagerEnabled_property\n  ...RentalContactForm_property\n}\n\nfragment FrChip_property on Property {\n  ...PriceAndFactsRow_property\n  ...AddressRow_property\n  ...StatusAndZestimateRow_property\n  ...IsRoomForRent_property\n}\n\nfragment PriceAndFactsRow_property on Property {\n  currency\n  postingProductType\n  bedrooms\n  ...BedBathBeyond_property\n}\n\nfragment BedBathBeyond_property on Property {\n  bedrooms\n  bathrooms\n  livingArea\n  homeType\n  lotSize\n  lotAreaValue\n  lotAreaUnits\n  livingAreaValue\n  livingAreaUnitsShort\n  state\n  resoFacts {\n    bathroomsFull\n    bathroomsThreeQuarter\n    bathroomsHalf\n    bathroomsOneQuarter\n  }\n}\n\nfragment AddressRow_property on Property {\n  ...Address_property\n  ...getDisplayAddress_property\n}\n\nfragment Address_property on Property {\n  streetAddress\n  city\n  state\n  zipcode\n  isUndisclosedAddress\n  formattedChip(xConsumerUsername: "hdp-web") {\n    location {\n      fullValue\n    }\n  }\n}\n\nfragment getDisplayAddress_property on Property {\n  streetAddress\n  marketingName\n  building {\n    buildingName\n  }\n  postingProductType\n}\n\nfragment StatusAndZestimateRow_property on Property {\n  rentZestimate\n  currency\n  homeType\n  isIncomeRestricted\n  postingProductType\n  ...StatusArea_property\n  ...RoomSizeAndHousemates_property\n}\n\nfragment StatusArea_property on Property {\n  homeStatus\n  homeType\n  attributionInfo {\n    trueStatus\n  }\n  listing_sub_type {\n    is_roomForRent\n  }\n}\n\nfragment RoomSizeAndHousemates_property on Property {\n  roomForRent {\n    roommateDetails {\n      totalCount\n    }\n    roomDetails {\n      roomArea\n      roomAreaUnits\n    }\n  }\n}\n\nfragment RentalContactForm_property on Property {\n  rentalApplicationsAcceptedType\n  providerListingID\n  isInstantTourEnabled\n  rentalInstantTour {\n    schedulingStatus\n    tourId\n    startTime\n    zoneId\n  }\n  odpPropertyModels {\n    rentalsSidecar {\n      rentalsSidecarListings {\n        tourSchedulingPayload {\n          inPersonTourEnabled\n          liveVideoTourEnabled\n          selfGuidedTourEnabled\n          instantTourConfigurations {\n            provider\n            tourType\n          }\n        }\n      }\n    }\n  }\n}\n\nfragment FrSummaryContent_viewer on Viewer {\n  ...GetShareWithCaseManagerEnabled_viewer\n}\n\nfragment GetShareWithCaseManagerEnabled_viewer on Viewer {\n  roles {\n    isLlpRenter\n  }\n}\n\nfragment FrSummaryContent_abTests on ABTests {\n  ...FrChip_abTests\n  RE_CANADA_CTA: abTest(trial: "RE_CANADA_CTA")\n}\n\nfragment FrChip_abTests on ABTests {\n  ...StatusAndZestimateRow_abTests\n  ...IsRoomForRent_abTests\n}\n\nfragment StatusAndZestimateRow_abTests on ABTests {\n  SEOTEST_REMOVE_RENT_ZESTIMATE: abTest(trial: "SEOTEST_REMOVE_RENT_ZESTIMATE")\n}\n\nfragment DsNeighborhood_abTests on ABTests {\n  ...DsNearbyHomes_abTests\n}\n\nfragment DsNearbyHomes_abTests on ABTests {\n  RE_Similar_Homes_new_position: abTest(trial: "RE_Similar_Homes_new_position")\n}\n\nfragment FrLightboxes_property on Property {\n  ...ReportProblemLightbox_property\n  ...Share_property\n  ...ShareWithCaseManagerLightbox_property\n  ...GetShareWithCaseManagerEnabled_property\n  ...MapLightboxContainer_property\n  ...MixedMediaLightbox_property\n}\n\nfragment ShareWithCaseManagerLightbox_property on Property {\n  ...Share_property\n}\n\nfragment MapLightboxContainer_property on Property {\n  ...GalleryLightboxMapGoogle_property\n}\n\nfragment GalleryLightboxMapGoogle_property on Property {\n  zpid\n  streetAddress\n  city\n  state\n  zipcode\n  latitude\n  longitude\n  isUndisclosedAddress\n  streetViewTileImageUrlMediumLatLong: googleStreetViewImageSignedUrl(\n    featureArea: "hdpMediaWall"\n    locationType: LAT_LONG\n    width: 400\n    height: 250\n  )\n  streetViewTileImageUrlMediumAddress: googleStreetViewImageSignedUrl(\n    featureArea: "hdpMediaWall"\n    locationType: ADDRESS\n    width: 400\n    height: 250\n  )\n  ...GalleryLightboxActionButtons_property\n  ...GoogleStreetViewPanorama_property\n  ...LotLinesMap_property\n  ...GetShareWithCaseManagerEnabled_property\n}\n\nfragment LotLinesMap_property on Property {\n  latitude\n  longitude\n  homeStatus\n  zpid\n  price\n  thumb: photos(count: 1, size: THUMBNAIL) {\n    url\n  }\n  neighborhoodMapThumb: photos(count: 1, size: S) {\n    url\n  }\n}\n\nfragment GalleryLightboxActionButtons_property on Property {\n  zpid\n  homeStatus\n  isPremierBuilder\n  address {\n    streetAddress\n    city\n    state\n    zipcode\n  }\n  ...SaveHome_property\n  ...Variant_property\n  ...HomeDetailsContactUpsell_property\n}\n\nfragment GoogleStreetViewPanorama_property on Property {\n  zpid\n  longitude\n  latitude\n  streetViewMetadataUrlMapLightboxAddress: googleStreetViewMetadataSignedUrl(\n    featureArea: "hdpMapLightbox"\n    locationType: ADDRESS\n  )\n}\n\nfragment MixedMediaLightbox_property on Property {\n  zpid\n  homeStatus\n  photoCount\n  address {\n    city\n    state\n    streetAddress\n    zipcode\n  }\n  ...GalleryLightboxActionButtons_property\n  ...SphereViewerContainer_property\n  ...ShouldShowVideo_property\n  ...ShouldShowVirtualTour_property\n  ...VideoContainer_property\n  ...GalleryLightboxFooter_property\n  ...GalleryLightboxResponsiveGallery_property\n  ...CommunityStyle_property\n  ...GalleryLightboxThirdPartyVirtualTour_property\n  ...GetShareWithCaseManagerEnabled_property\n  responsivePhotosOriginalRatio: photos {\n    caption\n    key: photoKey\n    mixedSources(aspectRatio: Original) {\n      jpeg {\n        url\n        width\n      }\n      webp {\n        url\n        width\n      }\n    }\n  }\n  ...couldShowEmbeddedThirdPartyVirtualTour_property\n}\n\nfragment VideoContainer_property on Property {\n  ...VideoWalkthroughContainer_property\n  ...GalleryLightboxHeaderMobile_property\n}\n\nfragment VideoWalkthroughContainer_property on Property {\n  primaryPublicVideo {\n    videoIdEncoded\n    postingClient\n    sourceVideoWidth\n    sourceVideoHeight\n    sources {\n      presetName\n      src\n      type\n    }\n  }\n  richMediaVideos {\n    mp4Url\n    hlsUrl\n  }\n}\n\nfragment GalleryLightboxHeaderMobile_property on Property {\n  ...SaveHome_property\n}\n\nfragment GalleryLightboxFooter_property on Property {\n  ...GalleryLightboxHomeInfo_property\n}\n\nfragment GalleryLightboxHomeInfo_property on Property {\n  price\n  lastSoldPrice\n  bedrooms\n  bathrooms\n  livingArea\n  livingAreaValue\n  livingAreaUnits\n  homeStatus\n  homeType\n  currency\n  listing_sub_type {\n    is_newHome\n    is_FSBO\n    is_bankOwned\n    is_foreclosure\n    is_forAuction\n    is_comingSoon\n  }\n  contingentListingType\n  attributionInfo {\n    trueStatus\n  }\n  isPremierBuilder\n  newConstructionType\n}\n\nfragment GalleryLightboxResponsiveGallery_property on Property {\n  homeStatus\n  isPremierBuilder\n  ...GalleryLightboxHeaderMobile_property\n  ...GalleryLightboxActionButtons_property\n  ...GalleryLightboxContactUpsell_property\n}\n\nfragment GalleryLightboxContactUpsell_property on Property {\n  ...HomeDetailsContactUpsell_property\n}\n\nfragment GalleryLightboxThirdPartyVirtualTour_property on Property {\n  thirdPartyVirtualTour {\n    lightboxUrl\n  }\n  ...couldShowEmbeddedThirdPartyVirtualTour_property\n}\n\nfragment CommunityStyle_property on Property {\n  homeType\n}\n\nfragment FrLightboxes_viewer on Viewer {\n  ...ReportProblemLightbox_viewer\n  ...ShareWithCaseManagerLightbox_viewer\n  ...GetShareWithCaseManagerEnabled_viewer\n  ...MapLightboxContainer_viewer\n  ...MixedMediaLightbox_viewer\n}\n\nfragment ShareWithCaseManagerLightbox_viewer on Viewer {\n  caseworker {\n    emailAddress\n    zuid\n  }\n}\n\nfragment MapLightboxContainer_viewer on Viewer {\n  ...GalleryLightboxMapGoogle_viewer\n}\n\nfragment GalleryLightboxMapGoogle_viewer on Viewer {\n  ...GetShareWithCaseManagerEnabled_viewer\n}\n\nfragment MixedMediaLightbox_viewer on Viewer {\n  ...GalleryLightboxActionButtons_viewer\n  ...GalleryLightboxResponsiveGallery_viewer\n  ...GetShareWithCaseManagerEnabled_viewer\n}\n\nfragment GalleryLightboxResponsiveGallery_viewer on Viewer {\n  ...GalleryLightboxContactUpsell_viewer\n}\n\nfragment GalleryLightboxContactUpsell_viewer on Viewer {\n  ...HomeDetailsContactUpsell_viewer\n}\n\nfragment HomeDetailsContactUpsell_viewer on Viewer {\n  ...DsContactButtons_viewer\n}\n\nfragment DsContactButtons_viewer on Viewer {\n  email\n}\n\nfragment GalleryLightboxActionButtons_viewer on Viewer {\n  ...HomeDetailsContactUpsell_viewer\n}\n\nfragment FrLightboxes_abTests on ABTests {\n  ...MixedMediaLightbox_abTests\n}\n\nfragment MixedMediaLightbox_abTests on ABTests {\n  RMX_LIGHTBOX_CHROME_1_5: abTest(trial: "RMX_LIGHTBOX_CHROME_1.5")\n  ...SphereViewerContainer_abTests\n  ...GalleryLightboxResponsiveGallery_abTests\n  ...GalleryLightboxActionButtons_abTests\n}\n\nfragment SphereViewerContainer_abTests on ABTests {\n  DELETE_WHEN_REAL_TRIAL_ADDED: abTest(trial: "DELETE_WHEN_REAL_TRIAL_ADDED")\n}\n\nfragment GalleryLightboxResponsiveGallery_abTests on ABTests {\n  ...GalleryLightboxContactUpsell_abTests\n}\n\nfragment GalleryLightboxContactUpsell_abTests on ABTests {\n  ...HomeDetailsContactUpsell_abTests\n}\n\nfragment HomeDetailsContactUpsell_abTests on ABTests {\n  ...DsContactButtons_abTests\n}\n\nfragment DsContactButtons_abTests on ABTests {\n  __typename\n}\n\nfragment GalleryLightboxActionButtons_abTests on ABTests {\n  ...HomeDetailsContactUpsell_abTests\n}\n\nfragment UniversalAnalyticsDataLayerFragment_property on Property {\n  ...PropertyInfoBlockFragment_property\n  ...Variant_property\n}\n\nfragment PropertyInfoBlockFragment_property on Property {\n  zpid\n  buildingId\n  virtualTourUrl\n  isPremierBuilder\n  isShowcaseListing\n  thirdPartyVirtualTour {\n    providerKey\n  }\n  ...ShouldShowVirtualTour_property\n  ...IMXRichMedia_property\n  ...IMXLightboxEntryFragments_property\n}\n\nfragment UniversalAnalyticsDataLayerFragment_abTests on ABTests {\n  ...PropertyInfoBlockFragment_abTests\n  ...Variant_abTests\n}\n\nfragment PropertyInfoBlockFragment_abTests on ABTests {\n  ...IMXLightboxEntryFragments_abTests\n}\n\nfragment IMXLightboxEntryFragments_abTests on ABTests {\n  IMX_REPORT_PROBLEM: abTest(trial: "IMX_REPORT_PROBLEM")\n  RMX_HIGH_RES_PHOTO: abTest(trial: "RMX_HIGH_RES_PHOTO")\n  IMX_FSHDP_MICRO_FRONTEND: abTest(trial: "IMX_FSHDP_MICRO_FRONTEND")\n  ...IMXViewContainer_abTests\n  ...SphereViewerContainer_abTests\n  ...IMXViewMenu_abTests\n}\n\nfragment IMXViewContainer_abTests on ABTests {\n  ...IMXAttribution_abTests\n}\n\nfragment IMXAttribution_abTests on ABTests {\n  DELETE_WHEN_REAL_TRIAL_ADDED: abTest(trial: "DELETE_WHEN_REAL_TRIAL_ADDED")\n}\n\nfragment IMXViewMenu_abTests on ABTests {\n  GROUP_BY_ROOM_TOGGLE_IMX_LIGHTBOX: abTest(\n    trial: "GROUP_BY_ROOM_TOGGLE_IMX_LIGHTBOX"\n  )\n}\n\nfragment Variant_abTests on ABTests {\n  SPT_RENDER_FOR_SALE_PAGE: abTest(trial: "SPT_RENDER_FOR_SALE_PAGE")\n}\n\nfragment RentalContactForm_abTests_hdp on ABTests {\n  ...RentalContactForm_abTests_shared\n  HDP_INSTANT_TOUR: abTest(trial: "HDP_INSTANT_TOUR")\n}\n\nfragment RentalContactForm_abTests_shared on ABTests {\n  RE_RENTER_PROFILE_ENABLE_CLEAR_DATA: abTest(\n    trial: "RE_RENTER_PROFILE_ENABLE_CLEAR_DATA"\n  )\n  RE_Contact_Property_CTA: abTest(trial: "RE_Contact_Property_CTA")\n  RE_RP_NO_DELAY: abTest(trial: "RE_RP_NO_DELAY")\n  SI_IncomeRestrictedDisclaimer: abTest(trial: "SI_IncomeRestrictedDisclaimer")\n  SI_LLP_DirectToEmployer: abTest(trial: "SI_LLP_DirectToEmployer")\n  RE_CTA_BUTTONS: abTest(trial: "RE_CTA_BUTTONS")\n  RC_INLINE_FORM_REDUCED: abTest(trial: "RC-INLINE_FORM_REDUCED")\n  RC_RENTER_PROFILE_VOUCHER: abTest(trial: "RC_RENTER_PROFILE_VOUCHER")\n  RC_PREFILL_CONTACT_INFO: abTest(trial: "RC_PREFILL_CONTACT_INFO")\n  RC_QUALIFICATION_FLOW: abTest(trial: "RC_QUALIFICATION_FLOW")\n  RC_RP_DETAIL_INCOME: abTest(trial: "RC_RP_DETAIL_INCOME")\n  RC_HDP_MULTICONTACT: abTest(trial: "RC_HDP_MULTICONTACT")\n}\n\nfragment ForRentSearchPageStateParamsFragment_property on Property {\n  latitude\n  longitude\n  cityId\n  stateId\n  boroughId\n  countyId\n}\n\nfragment RentalPrequalificationCard on ABTests {\n  RC_QUALIFICATION_FLOW: abTest(trial: "RC_QUALIFICATION_FLOW")\n}\n',
  }

  const newAbortSignal = (timeoutMs: number) => {
    const abortController = new AbortController()
    setTimeout(() => abortController.abort(), timeoutMs || 0)
    return abortController.signal
  }

  const zillowCookie = await getZillowCookie()
  const headers = {
    ...zillowListingHeaders,
    cookie: zillowCookie,
  }

  const config = {
    headers,
    ...(timeoutMs && { signal: newAbortSignal(timeoutMs) }),
  }

  const { data } = await axios.post(url, body, config) || {}
  return data?.data
}

export const getZillowListingContactDetailsByZpid = async (zpid: string): Promise<ZillowListing> => {
  const baseUrl = 'https://www.zillow.com/graphql'
  const body = {
    operationName: 'ListingContactDetailsQuery',
    variables: {
      zpid,
      altId: null,
    },
    query: 'query ListingContactDetailsQuery($zpid: ID!, $altId: ID) {\n  viewer {\n    roles {\n      isLandlordLiaisonMember\n      isLlpRenter\n    }\n  }\n  property(zpid: $zpid, palsId: $altId) {\n    zpid\n    brokerId\n    isHousingConnectorExclusive\n    rentalListingOwnerReputation {\n      responseRate\n      responseTimeMs\n      contactCount\n      applicationCount\n      isLandlordIdVerified\n    }\n    isFeatured\n    isListedByOwner\n    rentalListingOwnerContact {\n      displayName\n      businessName\n      phoneNumber\n      agentBadgeType\n      photoUrl\n      reviewsReceivedCount\n      reviewsUrl\n      ratingAverage\n      isBrokerLocalCompliance\n    }\n    postingProductType\n    postingContact {\n      brokerName\n      brokerageName\n      name\n    }\n    postingUrl\n    rentalMarketingTreatments\n    building {\n      bdpUrl\n      buildingName\n      housingConnector {\n        hcLink {\n          text\n        }\n      }\n      ppcLink {\n        text\n      }\n    }\n    roomForRent {\n      postedBy\n    }\n    attributionInfo {\n      listingAttributionContact\n      listingAgentAttributionContact\n    }\n  }\n}\n',
  }
  const { data } = await axios.post(baseUrl, body, { headers: zillowListingHeaders }) || {}
  return data?.data?.property
}
